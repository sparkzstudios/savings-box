<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#070710">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SavingsBox">
<link rel="manifest" href="manifest.json">
<title>üí∞ Savings Box</title>
<link href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#070710;--surface:#0e0e1c;--surface2:#16162a;--surface3:#1e1e38;
  --border:#2a2a4a;--border2:#3a3a5a;--text:#f0f0ff;--muted:#7070a0;--dim:#404070;
  --c1:#a855f7;--c2:#22d3ee;--c3:#fbbf24;--c4:#34d399;--c5:#fb7185;--c6:#818cf8;
  --g1:linear-gradient(135deg,#a855f7,#22d3ee);
  --g2:linear-gradient(135deg,#fbbf24,#fb7185);
  --g3:linear-gradient(135deg,#34d399,#22d3ee);
  --g4:linear-gradient(135deg,#818cf8,#a855f7);
  --r:14px;
  --nav-h:60px;
  --bot-h:env(safe-area-inset-bottom,0px);
  --bot-nav:68px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overscroll-behavior:none}
body{
  font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);
  min-height:100%;overflow-x:hidden;
  padding-bottom:calc(var(--bot-nav) + var(--bot-h));
}
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 70% 50% at 10% 10%,rgba(168,85,247,.1) 0%,transparent 55%),
    radial-gradient(ellipse 60% 40% at 90% 85%,rgba(34,211,238,.07) 0%,transparent 55%),
    radial-gradient(ellipse 50% 40% at 50% 50%,rgba(251,191,36,.04) 0%,transparent 55%);
}

/* ‚îÄ‚îÄ TOP NAV (desktop) ‚îÄ‚îÄ */
nav.top-nav{
  position:sticky;top:0;z-index:100;
  background:rgba(7,7,16,.9);backdrop-filter:blur(24px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;padding:0 24px;
  height:var(--nav-h);
}
.logo{
  font-family:'Clash Display',sans-serif;font-weight:700;font-size:1.2rem;
  background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-right:auto;letter-spacing:-.5px;
}
.nav-tab{
  padding:6px 16px;border-radius:8px;border:none;background:transparent;
  color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.78rem;font-weight:500;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.nav-tab:hover{color:var(--text);background:var(--surface2)}
.nav-tab.active{color:var(--text);background:var(--surface2);box-shadow:inset 0 -2px 0 var(--c1)}

/* ‚îÄ‚îÄ BOTTOM NAV (mobile) ‚îÄ‚îÄ */
.bot-nav{
  display:none;
  position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:rgba(14,14,28,.97);backdrop-filter:blur(24px);
  border-top:1px solid var(--border);
  padding-bottom:var(--bot-h);
  height:calc(var(--bot-nav) + var(--bot-h));
}
.bot-nav-inner{display:flex;justify-content:space-around;align-items:center;height:var(--bot-nav)}
.bot-tab{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  background:none;border:none;cursor:pointer;padding:8px 20px;
  color:var(--muted);transition:all .2s;flex:1;
}
.bot-tab .bi{font-size:1.3rem;transition:transform .2s}
.bot-tab .bl{font-size:.55rem;letter-spacing:.5px;text-transform:uppercase;font-weight:600}
.bot-tab.active{color:var(--c1)}
.bot-tab.active .bi{transform:scale(1.15)}

/* ‚îÄ‚îÄ PAGE ‚îÄ‚îÄ */
.page{display:none;padding:24px 20px;max-width:1120px;margin:0 auto;position:relative;z-index:1;min-height:100vh}
.page.active{display:block;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.page-title{font-family:'Clash Display',sans-serif;font-size:1.9rem;font-weight:700;letter-spacing:-.8px;margin-bottom:4px}
.page-sub{color:var(--muted);font-size:.75rem;margin-bottom:20px}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:20px}
.stat-box{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:14px 16px;cursor:default;
}
.stat-lbl{font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px}
.stat-val{font-size:1.25rem;font-weight:700;background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-val.g2{background:var(--g2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-val.g3{background:var(--g3);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-val.g4{background:var(--g4);-webkit-background-clip:text;-webkit-text-fill-color:transparent}

/* ‚îÄ‚îÄ SORT/FILTER BAR ‚îÄ‚îÄ */
.toolbar{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.sort-select{
  background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.7rem;
  padding:6px 10px;cursor:pointer;outline:none;
}
.sort-select:focus{border-color:var(--c1);color:var(--text)}
.toolbar-label{font-size:.65rem;color:var(--dim);text-transform:uppercase;letter-spacing:1px}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.goal-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:20px;cursor:pointer;position:relative;overflow:hidden;
  transition:transform .2s,border-color .2s,box-shadow .2s;
}
.goal-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.goal-card[data-c="0"]::before{background:var(--g1)}
.goal-card[data-c="1"]::before{background:var(--g2)}
.goal-card[data-c="2"]::before{background:var(--g3)}
.goal-card[data-c="3"]::before{background:var(--g4)}
@media(hover:hover){.goal-card:hover{transform:translateY(-4px);border-color:var(--c1);box-shadow:0 12px 40px rgba(168,85,247,.2)}}
.gc-name{font-family:'Clash Display',sans-serif;font-size:1rem;font-weight:600;margin-bottom:2px}
.gc-note-preview{font-size:.62rem;color:var(--dim);margin-bottom:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.gc-meta{font-size:.67rem;color:var(--muted);margin-bottom:12px}
.gc-saved{font-size:1.65rem;font-weight:700;letter-spacing:-1px;margin-bottom:2px}
.gc-target{font-size:.7rem;color:var(--muted);margin-bottom:10px}
.pbar{height:5px;background:var(--surface3);border-radius:5px;overflow:hidden;margin-bottom:12px}
.pfill{height:100%;border-radius:5px;position:relative;overflow:hidden;transition:width .7s cubic-bezier(.34,1.56,.64,1)}
.pfill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shim 2s infinite}
@keyframes shim{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
.goal-card[data-c="0"] .pfill{background:var(--g1)}
.goal-card[data-c="1"] .pfill{background:var(--g2)}
.goal-card[data-c="2"] .pfill{background:var(--g3)}
.goal-card[data-c="3"] .pfill{background:var(--g4)}
.gc-footer{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:.62rem;font-weight:600}
.badge-purple{background:rgba(168,85,247,.15);color:var(--c1);border:1px solid rgba(168,85,247,.3)}
.badge-cyan{background:rgba(34,211,238,.15);color:var(--c2);border:1px solid rgba(34,211,238,.3)}
.badge-green{background:rgba(52,211,153,.15);color:var(--c4);border:1px solid rgba(52,211,153,.3)}
.badge-red{background:rgba(251,113,133,.15);color:var(--c5);border:1px solid rgba(251,113,133,.3)}
.badge-amber{background:rgba(251,191,36,.15);color:var(--c3);border:1px solid rgba(251,191,36,.3)}

/* ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ */
.detail-header{display:flex;align-items:center;gap:10px;margin-bottom:18px;flex-wrap:wrap}
.back-btn{
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:10px 14px;cursor:pointer;color:var(--text);font-size:1rem;
  transition:.2s;font-family:inherit;min-width:44px;min-height:44px;
  display:flex;align-items:center;justify-content:center;
}
.back-btn:hover{background:var(--surface3)}
.dh-title{font-family:'Clash Display',sans-serif;font-size:1.6rem;font-weight:700;letter-spacing:-.5px;flex:1;min-width:140px}
.dh-actions{display:flex;gap:8px;flex-wrap:wrap}

/* ‚îÄ‚îÄ INFO STRIP ‚îÄ‚îÄ */
.info-strip{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:18px 20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));
  gap:14px;margin-bottom:14px;
}
.is-lbl{font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px}
.is-val{font-size:1rem;font-weight:700}
.is-val.big{font-size:1.4rem;background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.is-val.urgent{color:var(--c5)!important;-webkit-text-fill-color:var(--c5)}
.is-val.ok{color:var(--c4)!important;-webkit-text-fill-color:var(--c4)}
.is-val.far{color:var(--c2)!important;-webkit-text-fill-color:var(--c2)}
.big-pbar{height:8px;background:var(--surface3);border-radius:8px;overflow:hidden;margin-bottom:20px}
.big-pfill{height:100%;background:var(--g1);border-radius:8px;position:relative;overflow:hidden;transition:width .8s cubic-bezier(.34,1.56,.64,1)}
.big-pfill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shim 2s infinite}

/* ‚îÄ‚îÄ NOTE DISPLAY ‚îÄ‚îÄ */
.goal-note{
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:12px 14px;margin-bottom:16px;font-size:.75rem;color:var(--muted);
  line-height:1.6;display:none;
}
.goal-note.has-note{display:block}
.goal-note-label{font-size:.58rem;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px}

/* ‚îÄ‚îÄ GRID CONTROLS ‚îÄ‚îÄ */
.box-section{margin-bottom:24px}
.box-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.section-lbl{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px}
.box-legend{font-size:.64rem;color:var(--dim)}
.grid-controls{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.grid-filter-btn{
  padding:5px 12px;border-radius:20px;border:1px solid var(--border);
  background:var(--surface2);color:var(--muted);font-family:'JetBrains Mono',monospace;
  font-size:.63rem;cursor:pointer;transition:all .18s;
}
.grid-filter-btn.active{border-color:var(--c1);color:var(--c1);background:rgba(168,85,247,.1)}

/* ‚îÄ‚îÄ SAVINGS BOX CELL ‚îÄ‚îÄ */
.savings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(68px,1fr));gap:7px}
.sbox{
  aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  cursor:pointer;transition:all .18s;position:relative;user-select:none;overflow:hidden;
  min-width:44px;min-height:44px;
}
@media(hover:hover){.sbox:hover:not(.crossed){border-color:var(--c1);background:var(--surface3);transform:scale(1.06);box-shadow:0 4px 18px rgba(168,85,247,.25)}}
.sbox.crossed{background:rgba(168,85,247,.1);border-color:rgba(168,85,247,.5)}
.cross-lines{position:absolute;inset:5px;opacity:0;transition:opacity .2s;pointer-events:none}
.cross-lines::before,.cross-lines::after{content:'';position:absolute;inset:0;background:var(--c1)}
.cross-lines::before{top:50%;left:0;right:0;height:2px;margin-top:-1px;transform:rotate(45deg) scaleX(1.3);border-radius:2px}
.cross-lines::after{top:50%;left:0;right:0;height:2px;margin-top:-1px;transform:rotate(-45deg) scaleX(1.3);border-radius:2px}
.sbox.crossed .cross-lines{opacity:1}
.sbox.crossed .sbox-val{opacity:.3}
.sbox-val{font-size:.72rem;font-weight:700;z-index:1;transition:opacity .2s;line-height:1;text-align:center}
.sbox-val.sm{font-size:.6rem}
.sbox-val.xs{font-size:.52rem}
.sbox-dot{width:5px;height:5px;border-radius:50%;margin-top:3px;z-index:1;flex-shrink:0}
@keyframes pop{0%{transform:scale(1)}40%{transform:scale(1.22)}70%{transform:scale(.96)}100%{transform:scale(1)}}
.popping{animation:pop .3s ease}

/* ‚îÄ‚îÄ DENOM LEGEND ‚îÄ‚îÄ */
.denom-legend{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px}
.dl-item{display:flex;align-items:center;gap:4px;font-size:.6rem;color:var(--muted)}
.dl-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
.log-list{display:flex;flex-direction:column;gap:6px}
.log-item{display:flex;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 13px;transition:border-color .2s}
.log-item:hover{border-color:var(--border2)}
.li-date{font-size:.65rem;color:var(--muted);min-width:80px;flex-shrink:0}
.li-desc{flex:1;font-size:.68rem;color:var(--muted)}
.li-amt{font-size:.82rem;font-weight:600;color:var(--c4)}

/* ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ */
.streak-bar{display:flex;gap:3px;flex-wrap:wrap;margin-bottom:20px}
.streak-day{width:22px;height:22px;border-radius:5px;background:var(--surface2);border:1px solid var(--border);transition:all .2s;flex-shrink:0}
.streak-day.active{background:var(--c1);border-color:var(--c1);box-shadow:0 0 8px rgba(168,85,247,.4)}
.streak-day.today{border-color:var(--c2)}

/* ‚îÄ‚îÄ MODAL (default - desktop center) ‚îÄ‚îÄ */
.overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.85);backdrop-filter:blur(10px);
  z-index:300;align-items:center;justify-content:center;padding:20px;
}
.overlay.open{display:flex;animation:fi .2s ease}
@keyframes fi{from{opacity:0}to{opacity:1}}
.modal{
  background:var(--surface);border:1px solid var(--border);border-radius:20px;
  padding:28px;width:100%;max-width:480px;
  animation:si .3s cubic-bezier(.34,1.56,.64,1);
  max-height:90vh;overflow-y:auto;
}
@keyframes si{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.modal-title{font-family:'Clash Display',sans-serif;font-size:1.25rem;font-weight:700;margin-bottom:20px}
.fg{margin-bottom:14px}
label{display:block;font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px}
input,select,textarea{
  width:100%;padding:11px 14px;background:var(--surface2);border:1px solid var(--border);
  border-radius:9px;color:var(--text);font-family:'JetBrains Mono',monospace;
  font-size:.85rem;outline:none;transition:border-color .2s,box-shadow .2s;
}
input:focus,select:focus,textarea:focus{border-color:var(--c1);box-shadow:0 0 0 3px rgba(168,85,247,.15)}
textarea{resize:vertical;min-height:64px;line-height:1.5}
select option{background:var(--surface2)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{
  display:inline-flex;align-items:center;gap:6px;padding:11px 20px;
  border-radius:10px;border:none;font-family:'JetBrains Mono',monospace;
  font-size:.78rem;font-weight:500;cursor:pointer;transition:all .18s;
  min-height:44px;touch-action:manipulation;
}
.btn-primary{background:var(--g1);color:#fff;box-shadow:0 4px 18px rgba(168,85,247,.4)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(168,85,247,.5)}
.btn-ghost{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--surface3)}
.btn-danger{background:rgba(251,113,133,.12);color:var(--c5);border:1px solid rgba(251,113,133,.3)}
.btn-danger:hover{background:rgba(251,113,133,.22)}
.btn-warn{background:rgba(251,191,36,.12);color:var(--c3);border:1px solid rgba(251,191,36,.3)}
.btn-warn:hover{background:rgba(251,191,36,.22)}
.btn-info{background:rgba(34,211,238,.1);color:var(--c2);border:1px solid rgba(34,211,238,.3)}
.btn-info:hover{background:rgba(34,211,238,.2)}
.btn-sm{padding:8px 13px;font-size:.68rem;border-radius:8px;min-height:38px}

/* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
.fab{
  position:fixed;bottom:calc(var(--bot-nav) + var(--bot-h) + 16px);right:20px;
  width:54px;height:54px;border-radius:50%;background:var(--g1);
  border:none;color:#fff;font-size:1.5rem;cursor:pointer;z-index:150;
  box-shadow:0 8px 28px rgba(168,85,247,.5);
  display:flex;align-items:center;justify-content:center;
  transition:transform .2s,box-shadow .2s;touch-action:manipulation;
}
.fab:hover{transform:scale(1.12) rotate(90deg);box-shadow:0 12px 36px rgba(168,85,247,.6)}

/* ‚îÄ‚îÄ TOASTS ‚îÄ‚îÄ */
.toasts{
  position:fixed;bottom:calc(var(--bot-nav) + var(--bot-h) + 16px);
  left:50%;transform:translateX(-50%);z-index:500;
  display:flex;flex-direction:column;gap:6px;pointer-events:none;
  max-width:calc(100vw - 40px);
}
.toast{
  background:var(--surface3);border:1px solid var(--border2);border-radius:10px;
  padding:10px 18px;font-size:.76rem;font-weight:500;white-space:nowrap;
  animation:tin .3s cubic-bezier(.34,1.56,.64,1);text-align:center;
}
@keyframes tin{from{opacity:0;transform:translateY(12px) scale(.9)}to{opacity:1;transform:translateY(0) scale(1)}}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-ico{font-size:3rem;margin-bottom:12px}
.empty-t{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:6px;font-family:'Clash Display',sans-serif}
.empty-s{font-size:.75rem}
.cf{position:fixed;pointer-events:none;z-index:999;animation:cfall 1.4s ease-out forwards;border-radius:2px}
@keyframes cfall{0%{opacity:1;transform:translateY(0) rotate(0)}100%{opacity:0;transform:translateY(200px) rotate(720deg)}}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px}

/* ‚îÄ‚îÄ SECTION DIVIDER ‚îÄ‚îÄ */
.sdiv{height:1px;background:var(--border);margin:20px 0}

/* ‚îÄ‚îÄ BACKUP/SETTINGS PAGE ‚îÄ‚îÄ */
.settings-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:20px;margin-bottom:14px;
}
.settings-card h3{font-family:'Clash Display',sans-serif;font-size:1rem;font-weight:600;margin-bottom:6px}
.settings-card p{font-size:.72rem;color:var(--muted);margin-bottom:14px;line-height:1.6}
.settings-row{display:flex;gap:10px;flex-wrap:wrap}

/* ‚îÄ‚îÄ MOBILE (<=600px) ‚îÄ‚îÄ */
@media(max-width:600px){
  nav.top-nav{display:none}
  .bot-nav{display:block}
  body{padding-top:0;padding-bottom:calc(var(--bot-nav) + var(--bot-h))}
  .page{padding:16px 14px;padding-top:20px}
  .page-title{font-size:1.55rem}
  .stats-row{grid-template-columns:1fr 1fr;gap:8px}
  .stat-box{padding:12px 14px}
  .stat-val{font-size:1.1rem}
  .frow{grid-template-columns:1fr}

  /* Bottom sheet modal on mobile */
  .overlay{align-items:flex-end;padding:0}
  .modal{
    border-radius:20px 20px 0 0;max-width:100%;padding:24px 18px;
    padding-bottom:calc(18px + env(safe-area-inset-bottom,0px));
    animation:su .35s cubic-bezier(.34,1.56,.64,1);
    max-height:92vh;
  }
  @keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}

  .savings-grid{grid-template-columns:repeat(auto-fill,minmax(58px,1fr));gap:5px}
  .sbox{border-radius:9px}
  .info-strip{grid-template-columns:1fr 1fr;gap:10px}
  .dh-actions{gap:6px}
  .detail-header{gap:8px}
  .dh-title{font-size:1.3rem}
  .fab{bottom:calc(var(--bot-nav) + var(--bot-h) + 12px);right:16px;width:50px;height:50px;font-size:1.3rem}
  .toasts{bottom:calc(var(--bot-nav) + var(--bot-h) + 80px)}
  .cards-grid{grid-template-columns:1fr}
  .modal-footer{flex-direction:column-reverse}
  .modal-footer .btn{justify-content:center}
  .btn-sm{padding:9px 13px;font-size:.7rem}
  .streak-day{width:18px;height:18px}
}

/* ‚îÄ‚îÄ TABLET (601-900px) ‚îÄ‚îÄ */
@media(min-width:601px) and (max-width:900px){
  .cards-grid{grid-template-columns:1fr 1fr}
  .stats-row{grid-template-columns:repeat(4,1fr)}
}

/* ‚îÄ‚îÄ LANDSCAPE MOBILE ‚îÄ‚îÄ */
@media(max-width:900px) and (orientation:landscape){
  .page{padding:12px 16px}
  .savings-grid{grid-template-columns:repeat(auto-fill,minmax(52px,1fr));gap:4px}
}

/* Active state on touch */
.sbox:active{transform:scale(.95)}
.btn:active{transform:scale(.97)}
.goal-card:active{transform:scale(.98)}

/* ‚îÄ‚îÄ PROGRESS RING (settings) ‚îÄ‚îÄ */
.progress-pill{
  height:4px;background:var(--surface3);border-radius:4px;overflow:hidden;margin-top:8px;
}
.progress-pill-fill{height:100%;background:var(--g3);border-radius:4px;transition:width .6s ease}
</style>
</head>
<body>

<!-- TOP NAV (desktop) -->
<nav class="top-nav">
  <div class="logo">üí∞ SavingsBox</div>
  <div style="display:flex;gap:4px">
    <button class="nav-tab active" data-page="dashboard">Home</button>
    <button class="nav-tab" data-page="all">All Goals</button>
    <button class="nav-tab" data-page="settings">Settings</button>
  </div>
</nav>

<!-- HOME PAGE -->
<div class="page active" id="page-dashboard">
  <div class="page-title">Dashboard</div>
  <div class="page-sub" id="dashSub"></div>
  <div class="stats-row">
    <div class="stat-box"><div class="stat-lbl">Total Saved</div><div class="stat-val" id="sTotalSaved">‚Ç®0</div></div>
    <div class="stat-box"><div class="stat-lbl">Active Goals</div><div class="stat-val g2" id="sGoals">0</div></div>
    <div class="stat-box"><div class="stat-lbl">Boxes Crossed</div><div class="stat-val g3" id="sCrossed">0</div></div>
    <div class="stat-box"><div class="stat-lbl">Remaining</div><div class="stat-val g4" id="sRemaining">‚Ç®0</div></div>
  </div>

  <!-- 30-day streak -->
  <div style="margin-bottom:18px">
    <div class="section-lbl" style="margin-bottom:8px">üî• Last 30 Days Activity</div>
    <div class="streak-bar" id="streakBar"></div>
  </div>

  <div class="toolbar">
    <span class="toolbar-label">Sort:</span>
    <select class="sort-select" id="dashSort" onchange="renderDash()">
      <option value="created">Recent</option>
      <option value="progress">Progress</option>
      <option value="deadline">Deadline</option>
      <option value="name">Name</option>
    </select>
  </div>

  <div class="cards-grid" id="dashCards"></div>
  <div id="dashEmpty" class="empty" style="display:none">
    <div class="empty-ico">üè¶</div>
    <div class="empty-t">No savings goals yet</div>
    <div class="empty-s">Press + to create your first saving box</div>
  </div>
</div>

<!-- ALL GOALS PAGE -->
<div class="page" id="page-all">
  <div class="page-title">All Goals</div>
  <div class="page-sub">Every saving box you've created</div>
  <div class="toolbar">
    <span class="toolbar-label">Sort:</span>
    <select class="sort-select" id="allSort" onchange="renderAll()">
      <option value="created">Recent</option>
      <option value="progress">Progress</option>
      <option value="deadline">Deadline</option>
      <option value="name">Name</option>
    </select>
  </div>
  <div class="cards-grid" id="allCards"></div>
  <div id="allEmpty" class="empty" style="display:none">
    <div class="empty-ico">üì¶</div>
    <div class="empty-t">No goals yet</div>
    <div class="empty-s">Create one from the Home tab</div>
  </div>
</div>

<!-- DETAIL PAGE -->
<div class="page" id="page-detail">
  <div class="detail-header">
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <div class="dh-title" id="dTitle">-</div>
    <div class="dh-actions">
      <button class="btn btn-warn btn-sm" onclick="resetGoal()">‚Ü∫ Reset</button>
      <button class="btn btn-danger btn-sm" onclick="deleteGoal()">üóë</button>
    </div>
  </div>

  <div class="info-strip">
    <div><div class="is-lbl">Saved So Far</div><div class="is-val big" id="dSaved">‚Ç®0</div></div>
    <div><div class="is-lbl">Target</div><div class="is-val" id="dTarget">‚Ç®0</div></div>
    <div><div class="is-lbl">Remaining</div><div class="is-val" id="dRemaining">‚Ç®0</div></div>
    <div><div class="is-lbl">Progress</div><div class="is-val" id="dPct">0%</div></div>
    <div><div class="is-lbl">Days Left</div><div class="is-val" id="dDaysLeft">-</div></div>
    <div><div class="is-lbl">Goal Date</div><div class="is-val" id="dGoalDate">-</div></div>
    <div><div class="is-lbl">Boxes Done</div><div class="is-val" id="dCrossed">0 / 0</div></div>
    <div><div class="is-lbl">Daily Need</div><div class="is-val" id="dDaily">-</div></div>
  </div>

  <div class="big-pbar"><div class="big-pfill" id="dPbar" style="width:0%"></div></div>

  <div class="goal-note" id="dNote">
    <div class="goal-note-label">üìù Notes</div>
    <div id="dNoteText"></div>
  </div>

  <div class="box-section">
    <div class="box-header">
      <div class="section-lbl">üé≤ Saving Grid</div>
      <div class="box-legend">Tap = cross ‚úï</div>
    </div>
    <div class="grid-controls">
      <button class="grid-filter-btn active" data-gf="all" onclick="setGridFilter('all')">All</button>
      <button class="grid-filter-btn" data-gf="uncrossed" onclick="setGridFilter('uncrossed')">To Do</button>
      <button class="grid-filter-btn" data-gf="crossed" onclick="setGridFilter('crossed')">Done</button>
    </div>
    <div class="savings-grid" id="savingsGrid"></div>
  </div>

  <!-- Denom legend -->
  <div class="denom-legend" id="denomLegend"></div>

  <div class="sdiv"></div>

  <div style="margin-bottom:24px">
    <div class="section-lbl" style="margin-bottom:10px">üìã Cross History</div>
    <div class="log-list" id="logList"></div>
    <div id="logEmpty" style="color:var(--dim);font-size:.73rem;text-align:center;padding:20px;display:none">No entries yet ‚Äî start crossing boxes!</div>
  </div>
</div>

<!-- SETTINGS PAGE -->
<div class="page" id="page-settings">
  <div class="page-title">Settings</div>
  <div class="page-sub">Backup, data & preferences</div>

  <div class="settings-card">
    <h3>üì§ Export Backup</h3>
    <p>Download all your goals and data as a JSON file to keep safe.</p>
    <button class="btn btn-info btn-sm" onclick="exportBackup()">‚¨á Export JSON</button>
  </div>

  <div class="settings-card">
    <h3>üì• Import Backup</h3>
    <p>Restore from a previously exported JSON backup. This merges with existing data.</p>
    <div class="settings-row">
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importBackup(event)">
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('importFile').click()">‚¨Ü Choose File</button>
    </div>
  </div>

  <div class="settings-card">
    <h3>üìä App Stats</h3>
    <p id="settingsStats" style="margin-bottom:0">Loading...</p>
  </div>

  <div class="settings-card">
    <h3>üóë Danger Zone</h3>
    <p>Permanently delete ALL goals and data. This cannot be undone.</p>
    <button class="btn btn-danger btn-sm" onclick="nukeAll()">‚ö† Delete All Data</button>
  </div>
</div>

<!-- BOTTOM NAV (mobile only) -->
<nav class="bot-nav">
  <div class="bot-nav-inner">
    <button class="bot-tab active" data-page="dashboard">
      <span class="bi">üè†</span>
      <span class="bl">Home</span>
    </button>
    <button class="bot-tab" data-page="all">
      <span class="bi">üì¶</span>
      <span class="bl">Goals</span>
    </button>
    <button class="bot-tab fab-tab" onclick="openModal()" style="color:var(--c1)">
      <span class="bi" style="background:var(--g1);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;color:#fff;box-shadow:0 4px 16px rgba(168,85,247,.5);margin-bottom:2px">+</span>
      <span class="bl">New</span>
    </button>
    <button class="bot-tab" data-page="settings">
      <span class="bi">‚öôÔ∏è</span>
      <span class="bl">Settings</span>
    </button>
  </div>
</nav>

<!-- FAB (desktop) -->
<button class="fab" id="fab" onclick="openModal()">+</button>

<!-- CREATE/EDIT MODAL -->
<div class="overlay" id="modal">
  <div class="modal">
    <div style="width:40px;height:4px;background:var(--border2);border-radius:4px;margin:0 auto 20px;display:none" id="modalHandle"></div>
    <div class="modal-title" id="modalTitle">üéØ New Saving Box</div>
    <div class="fg"><label>Goal Name</label><input type="text" id="iName" placeholder="iPhone 16, Vacation, Car..." autocomplete="off"></div>
    <div class="frow">
      <div class="fg"><label>Target Amount (‚Ç®)</label><input type="number" id="iTarget" placeholder="50000" min="1" inputmode="numeric"></div>
      <div class="fg"><label>Goal Date</label><input type="date" id="iDate"></div>
    </div>
    <div class="fg">
      <label>Number of Boxes</label>
      <select id="iCount">
        <option value="25">25 boxes</option>
        <option value="50" selected>50 boxes</option>
        <option value="100">100 boxes</option>
        <option value="150">150 boxes</option>
        <option value="200">200 boxes</option>
      </select>
    </div>
    <div class="fg">
      <label>Notes / Description (optional)</label>
      <textarea id="iNote" placeholder="What is this goal for? Any reminders..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="modalSubmitBtn" onclick="submitGoal()">‚ú® Create</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<script>
// ‚îÄ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DENOMS=[1,2,5,10,20,50,100,500,1000];
const DENOM_COLORS={1:'#a855f7',2:'#22d3ee',5:'#34d399',10:'#fbbf24',20:'#fb7185',50:'#818cf8',100:'#f472b6',500:'#38bdf8',1000:'#a3e635'};

// ‚îÄ‚îÄ‚îÄ DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let db;
function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('SavingsBoxV4',1);
    r.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains('goals')) d.createObjectStore('goals',{keyPath:'id'});
      if(!d.objectStoreNames.contains('logs')){
        const s=d.createObjectStore('logs',{keyPath:'id',autoIncrement:true});
        s.createIndex('goalId','goalId');
        s.createIndex('date','date');
      }
    };
    r.onsuccess=e=>{db=e.target.result;res()};
    r.onerror=rej;
  });
}
const txs=(store,mode='readonly')=>db.transaction(store,mode).objectStore(store);
const dbGet=(s,k)=>new Promise((r,j)=>{const q=txs(s).get(k);q.onsuccess=()=>r(q.result);q.onerror=j});
const dbGetAll=s=>new Promise((r,j)=>{const q=txs(s).getAll();q.onsuccess=()=>r(q.result);q.onerror=j});
const dbPut=(s,o)=>new Promise((r,j)=>{const q=txs(s,'readwrite').put(o);q.onsuccess=()=>r(q.result);q.onerror=j});
const dbDelete=(s,k)=>new Promise((r,j)=>{const q=txs(s,'readwrite').delete(k);q.onsuccess=()=>r();q.onerror=j});
const dbByIndex=(s,idx,val)=>new Promise((r,j)=>{const q=txs(s).index(idx).getAll(val);q.onsuccess=()=>r(q.result);q.onerror=j});

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentPage='dashboard', currentGoalId=null, colorIdx=0;
let editingGoalId=null;
let gridFilter='all';

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt=n=>'‚Ç®'+Number(n).toLocaleString('en-IN');
const today=()=>new Date().toISOString().split('T')[0];
const vibrate=p=>{try{navigator.vibrate&&navigator.vibrate(p)}catch(e){}};

function daysLeftInfo(dateStr){
  const t=new Date(dateStr),n=new Date();
  t.setHours(0,0,0,0);n.setHours(0,0,0,0);
  const d=Math.ceil((t-n)/86400000);
  if(d<0) return{text:Math.abs(d)+'d overdue',cls:'urgent'};
  if(d===0) return{text:'Last day!',cls:'urgent'};
  if(d===1) return{text:'1 day left',cls:'urgent'};
  if(d<=14) return{text:d+' days left',cls:'ok'};
  return{text:d+' days left',cls:'far'};
}

const totalSavedFor=g=>g.crossed.reduce((a,i)=>a+(g.boxes[i]||0),0);

function sortGoals(goals, sortBy){
  return [...goals].sort((a,b)=>{
    if(sortBy==='progress'){
      const pa=totalSavedFor(a)/a.target,pb=totalSavedFor(b)/b.target;
      return pb-pa;
    }
    if(sortBy==='deadline') return new Date(a.goalDate)-new Date(b.goalDate);
    if(sortBy==='name') return a.name.localeCompare(b.name);
    return b.createdAt-a.createdAt;
  });
}

function randomBoxes(count, target) {
  // Build list of usable denominations
  const usable = DENOMS.filter(d => d <= target);
  if (!usable.length) return Array(count).fill(1);

  const boxes = [];
  let remaining = target;

  for (let i = 0; i < count - 1; i++) {
    const slotsLeft = count - i;

    // Hard cap: leave at least 1 rupee for every remaining slot
    const maxForThis = remaining - (slotsLeft - 1);
    if (maxForThis <= 0) { boxes.push(1); remaining -= 1; continue; }

    const valid = usable.filter(d => d <= maxForThis);
    if (!valid.length) { boxes.push(1); remaining -= 1; continue; }

    // ‚îÄ‚îÄ DYNAMIC WEIGHTED PICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Re-calculate ideal average each step so distribution self-corrects
    // and never drifts toward tiny values near the end.
    const idealAvg = remaining / slotsLeft;

    // Log-normal bell curve: denominations near idealAvg get highest weight.
    // sigma=1.8 gives a wide enough spread so neighbouring denoms appear too.
    const SIGMA = 1.8;
    const ws = valid.map(d => {
      const logR = Math.log(d / idealAvg);
      return Math.exp(-(logR * logR) / (2 * SIGMA * SIGMA));
    });

    // Weighted random draw
    const total = ws.reduce((a, b) => a + b, 0);
    let rnd = Math.random() * total;
    let pick = valid[valid.length - 1];
    for (let j = 0; j < valid.length; j++) {
      rnd -= ws[j];
      if (rnd <= 0) { pick = valid[j]; break; }
    }

    boxes.push(pick);
    remaining -= pick;
  }

  // Last slot gets exactly whatever is left (guarantees sum === target)
  boxes.push(remaining);

  // Fisher-Yates shuffle so no positional pattern
  for (let i = boxes.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [boxes[i], boxes[j]] = [boxes[j], boxes[i]];
  }

  return boxes;
}

// ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.nav-tab').forEach(t=>t.addEventListener('click',()=>navigateTo(t.dataset.page)));
document.querySelectorAll('.bot-tab[data-page]').forEach(t=>t.addEventListener('click',()=>navigateTo(t.dataset.page)));

function navigateTo(page,gid){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab,.bot-tab').forEach(t=>t.classList.remove('active'));
  currentPage=page;
  document.getElementById('page-'+page).classList.add('active');
  document.querySelectorAll('[data-page="'+page+'"]').forEach(t=>t.classList.add('active'));
  const isMobile=window.innerWidth<=600;
  document.getElementById('fab').style.display=(page==='detail'||isMobile)?'none':'flex';
  if(page==='dashboard') renderDash();
  else if(page==='all') renderAll();
  else if(page==='detail'){currentGoalId=gid;gridFilter='all';renderDetail(gid);}
  else if(page==='settings') renderSettings();
}

function goBack(){navigateTo('dashboard')}

// Responsive FAB visibility
function updateFabVisibility(){
  const isMobile=window.innerWidth<=600;
  const fab=document.getElementById('fab');
  if(isMobile) fab.style.display='none';
  else fab.style.display=(currentPage==='detail')?'none':'flex';
  // Show modal handle on mobile
  document.getElementById('modalHandle').style.display=isMobile?'block':'none';
}
window.addEventListener('resize',updateFabVisibility);

// ‚îÄ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderStreak(){
  const logs=await dbGetAll('logs');
  const crossDates=new Set(logs.filter(l=>l.action==='cross').map(l=>l.date));
  const bar=document.getElementById('streakBar');
  bar.innerHTML='';
  const now=new Date();
  for(let i=29;i>=0;i--){
    const d=new Date(now);d.setDate(d.getDate()-i);
    const ds=d.toISOString().split('T')[0];
    const el=document.createElement('div');
    el.className='streak-day'+(crossDates.has(ds)?' active':'')+(i===0?' today':'');
    el.title=ds;
    bar.appendChild(el);
  }
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderDash(){
  const goals=await dbGetAll('goals');
  const totalSaved=goals.reduce((a,g)=>a+totalSavedFor(g),0);
  const totalTarget=goals.reduce((a,g)=>a+g.target,0);
  const totalCrossed=goals.reduce((a,g)=>a+g.crossed.length,0);
  const remaining=totalTarget-totalSaved;
  document.getElementById('sTotalSaved').textContent=fmt(totalSaved);
  document.getElementById('sGoals').textContent=goals.length;
  document.getElementById('sCrossed').textContent=totalCrossed;
  document.getElementById('sRemaining').textContent=fmt(Math.max(0,remaining));
  const now=new Date();
  document.getElementById('dashSub').textContent=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  await renderStreak();
  const container=document.getElementById('dashCards');
  const empty=document.getElementById('dashEmpty');
  if(!goals.length){container.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  container.innerHTML='';
  const sortBy=document.getElementById('dashSort').value;
  sortGoals(goals,sortBy).forEach(g=>container.appendChild(makeCard(g)));
}

async function renderAll(){
  const goals=await dbGetAll('goals');
  const container=document.getElementById('allCards');
  const empty=document.getElementById('allEmpty');
  if(!goals.length){container.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  container.innerHTML='';
  const sortBy=document.getElementById('allSort').value;
  sortGoals(goals,sortBy).forEach(g=>container.appendChild(makeCard(g)));
}

function makeCard(g){
  const saved=totalSavedFor(g);
  const pct=Math.min(100,Math.round(saved/g.target*100));
  const dl=daysLeftInfo(g.goalDate);
  const card=document.createElement('div');
  card.className='goal-card';card.dataset.c=g.color||'0';
  card.onclick=()=>navigateTo('detail',g.id);
  const noteHtml=g.note?`<div class="gc-note-preview">üìù ${g.note}</div>`:'';
  card.innerHTML=`
    <div class="gc-name">${g.name}</div>
    ${noteHtml}
    <div class="gc-meta">üéØ ${fmt(g.target)} &nbsp;¬∑&nbsp; üì¶ ${g.boxes.length} boxes</div>
    <div class="gc-saved">${fmt(saved)}</div>
    <div class="gc-target">${g.crossed.length} / ${g.boxes.length} crossed ¬∑ ${pct}% done</div>
    <div class="pbar"><div class="pfill" style="width:${pct}%"></div></div>
    <div class="gc-footer">
      <span class="badge badge-purple">${pct}%</span>
      <span class="badge badge-${dl.cls==='urgent'?'red':dl.cls==='ok'?'green':'cyan'}">üìÖ ${dl.text}</span>
      ${pct===100?'<span class="badge badge-amber">üéâ Done!</span>':''}
    </div>`;
  return card;
}

// ‚îÄ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderDetail(gid){
  const g=await dbGet('goals',gid);
  if(!g) return;
  const saved=totalSavedFor(g);
  const remaining=Math.max(0,g.target-saved);
  const pct=Math.min(100,Math.round(saved/g.target*100));
  const dl=daysLeftInfo(g.goalDate);
  document.getElementById('dTitle').textContent=g.name;
  document.getElementById('dSaved').textContent=fmt(saved);
  document.getElementById('dTarget').textContent=fmt(g.target);
  document.getElementById('dRemaining').textContent=fmt(remaining);
  document.getElementById('dPct').textContent=pct+'%';
  document.getElementById('dPbar').style.width=pct+'%';
  document.getElementById('dCrossed').textContent=g.crossed.length+' / '+g.boxes.length;
  document.getElementById('dGoalDate').textContent=new Date(g.goalDate).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  const dlEl=document.getElementById('dDaysLeft');
  dlEl.textContent=dl.text;dlEl.className='is-val '+dl.cls;
  // Daily need
  const daysLeftNum=Math.max(1,Math.ceil((new Date(g.goalDate)-new Date())/86400000));
  document.getElementById('dDaily').textContent=remaining>0?fmt(Math.ceil(remaining/daysLeftNum))+'/day':'Done!';
  // Note
  const noteEl=document.getElementById('dNote');
  if(g.note){noteEl.classList.add('has-note');document.getElementById('dNoteText').textContent=g.note;}
  else noteEl.classList.remove('has-note');
  renderGrid(g);
  renderDenomLegend(g);
  await renderLog(gid);
}

function setGridFilter(f){
  gridFilter=f;
  document.querySelectorAll('.grid-filter-btn').forEach(b=>b.classList.toggle('active',b.dataset.gf===f));
  dbGet('goals',currentGoalId).then(g=>g&&renderGrid(g));
}

function renderGrid(g){
  const grid=document.getElementById('savingsGrid');
  grid.innerHTML='';
  g.boxes.forEach((val,i)=>{
    const crossed=g.crossed.includes(i);
    if(gridFilter==='uncrossed'&&crossed) return;
    if(gridFilter==='crossed'&&!crossed) return;
    const el=document.createElement('div');
    el.className='sbox'+(crossed?' crossed':'');
    const vs=val>=1000?(val/1000)+'K':String(val);
    const sz=vs.length>3?'xs':vs.length>2?'sm':'';
    el.innerHTML=`<div class="cross-lines"></div><div class="sbox-val ${sz}">${vs}</div><div class="sbox-dot" style="background:${DENOM_COLORS[val]||'#888'}"></div>`;
    el.onclick=()=>toggleBox(g,i,el);
    grid.appendChild(el);
  });
}

function renderDenomLegend(g){
  const legend=document.getElementById('denomLegend');
  const seen=new Set(g.boxes);
  legend.innerHTML=[...seen].sort((a,b)=>a-b).map(d=>`<div class="dl-item"><div class="dl-dot" style="background:${DENOM_COLORS[d]||'#888'}"></div>${fmt(d)}</div>`).join('');
}

async function toggleBox(g,idx,el){
  const wasCrossed=g.crossed.includes(idx);
  if(wasCrossed){g.crossed=g.crossed.filter(x=>x!==idx);}
  else{g.crossed.push(idx);}
  await dbPut('goals',g);
  el.classList.toggle('crossed',!wasCrossed);
  el.classList.add('popping');
  el.addEventListener('animationend',()=>el.classList.remove('popping'),{once:true});
  if(!wasCrossed){
    vibrate([20,10,20]);
    await dbPut('logs',{goalId:g.id,boxIdx:idx,value:g.boxes[idx],date:today(),ts:Date.now(),action:'cross'});
    spawnParticle();
    if(g.crossed.length===g.boxes.length){setTimeout(spawnConfetti,300);vibrate([50,30,50,30,100]);}
  } else {
    vibrate(15);
    await dbPut('logs',{goalId:g.id,boxIdx:idx,value:g.boxes[idx],date:today(),ts:Date.now(),action:'uncross'});
  }
  const saved=totalSavedFor(g);
  const remaining=Math.max(0,g.target-saved);
  const pct=Math.min(100,Math.round(saved/g.target*100));
  document.getElementById('dSaved').textContent=fmt(saved);
  document.getElementById('dRemaining').textContent=fmt(remaining);
  document.getElementById('dPct').textContent=pct+'%';
  document.getElementById('dPbar').style.width=pct+'%';
  document.getElementById('dCrossed').textContent=g.crossed.length+' / '+g.boxes.length;
  await renderLog(g.id);
  if(!wasCrossed) showToast('‚úï  +'+fmt(g.boxes[idx]));
}

async function renderLog(gid){
  const logs=await dbByIndex('logs','goalId',gid);
  const crosses=logs.filter(l=>l.action==='cross').sort((a,b)=>b.ts-a.ts).slice(0,50);
  const list=document.getElementById('logList');
  const empty=document.getElementById('logEmpty');
  if(!crosses.length){list.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  list.innerHTML=crosses.map(l=>`
    <div class="log-item">
      <div class="li-date">${l.date}</div>
      <div class="li-desc">Box #${l.boxIdx+1} ¬∑ ${fmt(l.value)}</div>
      <div class="li-amt">+${fmt(l.value)}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(goalToEdit){
  editingGoalId=goalToEdit?goalToEdit.id:null;
  document.getElementById('modalTitle').textContent=editingGoalId?'‚úèÔ∏è Edit Goal':'üéØ New Saving Box';
  document.getElementById('modalSubmitBtn').textContent=editingGoalId?'‚ú® Save':'‚ú® Create';
  document.getElementById('iName').value=goalToEdit?goalToEdit.name:'';
  document.getElementById('iTarget').value=goalToEdit?goalToEdit.target:'';
  document.getElementById('iNote').value=goalToEdit?(goalToEdit.note||''):'';
  if(goalToEdit){
    document.getElementById('iDate').value=goalToEdit.goalDate;
    document.getElementById('iCount').value=goalToEdit.boxes.length;
    document.getElementById('iCount').disabled=true; // can't change box count when editing
  } else {
    const d=new Date();d.setMonth(d.getMonth()+3);
    document.getElementById('iDate').value=d.toISOString().split('T')[0];
    document.getElementById('iCount').value='50';
    document.getElementById('iCount').disabled=false;
  }
  document.getElementById('modal').classList.add('open');
  setTimeout(()=>document.getElementById('iName').focus(),150);
}

function closeModal(){document.getElementById('modal').classList.remove('open');editingGoalId=null;}
document.getElementById('modal').addEventListener('click',e=>{if(e.target===document.getElementById('modal'))closeModal()});

async function submitGoal(){
  const name=document.getElementById('iName').value.trim();
  const target=parseFloat(document.getElementById('iTarget').value);
  const goalDate=document.getElementById('iDate').value;
  const count=parseInt(document.getElementById('iCount').value);
  const note=document.getElementById('iNote').value.trim();
  if(!name||!target||!goalDate){showToast('‚ö†Ô∏è Fill all required fields!');return;}
  if(target<=0){showToast('‚ö†Ô∏è Target must be > 0');return;}
  if(editingGoalId){
    const g=await dbGet('goals',editingGoalId);
    g.name=name;g.target=target;g.goalDate=goalDate;g.note=note;
    await dbPut('goals',g);
    closeModal();showToast('‚úÖ Goal updated!');
    if(currentPage==='detail') renderDetail(editingGoalId);
    else renderDash();
  } else {
    const goal={id:Date.now(),name,target,goalDate,boxes:randomBoxes(count,target),crossed:[],color:String(colorIdx%4),createdAt:Date.now(),note};
    colorIdx++;
    await dbPut('goals',goal);
    closeModal();showToast('üéØ Saving box created!');spawnConfetti();renderDash();
  }
}

async function deleteGoal(){
  if(!confirm('Permanently delete "'+document.getElementById('dTitle').textContent+'" and all its data?')) return;
  const logs=await dbByIndex('logs','goalId',currentGoalId);
  for(const l of logs) await dbDelete('logs',l.id);
  await dbDelete('goals',currentGoalId);
  showToast('üóë Goal deleted');navigateTo('dashboard');
}

async function resetGoal(){
  if(!confirm('Reset all crossed boxes? Cross history will be cleared.')) return;
  const g=await dbGet('goals',currentGoalId);
  g.crossed=[];
  await dbPut('goals',g);
  const logs=await dbByIndex('logs','goalId',currentGoalId);
  for(const l of logs) await dbDelete('logs',l.id);
  showToast('‚Ü∫ Goal reset ‚Äî all boxes uncrossed');
  renderDetail(currentGoalId);
}

// ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderSettings(){
  const goals=await dbGetAll('goals');
  const logs=await dbGetAll('logs');
  const totalSaved=goals.reduce((a,g)=>a+totalSavedFor(g),0);
  document.getElementById('settingsStats').innerHTML=
    `Goals: <b>${goals.length}</b> &nbsp;¬∑&nbsp; Log entries: <b>${logs.length}</b> &nbsp;¬∑&nbsp; Total saved: <b>${fmt(totalSaved)}</b>`;
}

async function exportBackup(){
  const goals=await dbGetAll('goals');
  const logs=await dbGetAll('logs');
  const data={version:1,exported:new Date().toISOString(),goals,logs};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=`savings-box-backup-${today()}.json`;a.click();
  URL.revokeObjectURL(url);
  showToast('üì§ Backup exported!');
}

async function importBackup(e){
  const file=e.target.files[0];if(!file) return;
  try{
    const text=await file.text();
    const data=JSON.parse(text);
    if(!data.goals||!Array.isArray(data.goals)) throw new Error('Invalid backup');
    let count=0;
    for(const g of data.goals){await dbPut('goals',g);count++;}
    for(const l of data.logs||[]){
      const{id:_,...rest}=l;
      await dbPut('logs',{...rest,id:Date.now()+Math.random()});
    }
    showToast(`üì• Imported ${count} goals!`);
    renderSettings();
  } catch(err){
    showToast('‚ùå Import failed ‚Äî invalid file');
  }
  e.target.value='';
}

async function nukeAll(){
  if(!confirm('Delete ALL data permanently? This CANNOT be undone!')) return;
  const goals=await dbGetAll('goals');
  for(const g of goals) await dbDelete('goals',g.id);
  const logs=await dbGetAll('logs');
  for(const l of logs) await dbDelete('logs',l.id);
  showToast('üí• All data deleted');
  renderSettings();
}

// ‚îÄ‚îÄ‚îÄ FX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg){
  const t=document.createElement('div');t.className='toast';t.textContent=msg;
  document.getElementById('toasts').appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity .3s';setTimeout(()=>t.remove(),300)},2700);
}

function spawnParticle(){
  const colors=['#a855f7','#22d3ee','#fbbf24','#34d399','#fb7185'];
  for(let i=0;i<8;i++){
    setTimeout(()=>{
      const el=document.createElement('div');el.className='cf';
      el.style.cssText=`left:${20+Math.random()*60}vw;top:${20+Math.random()*50}vh;background:${colors[Math.floor(Math.random()*colors.length)]};width:${5+Math.random()*6}px;height:${5+Math.random()*6}px;border-radius:50%`;
      document.body.appendChild(el);setTimeout(()=>el.remove(),1500);
    },i*35);
  }
}

function spawnConfetti(){
  showToast('üéâ All boxes crossed! Goal achieved!');
  const colors=['#a855f7','#22d3ee','#fbbf24','#34d399','#fb7185','#818cf8','#f472b6'];
  for(let i=0;i<80;i++){
    setTimeout(()=>{
      const el=document.createElement('div');el.className='cf';
      el.style.cssText=`left:${Math.random()*100}vw;top:${Math.random()*20}vh;background:${colors[Math.floor(Math.random()*colors.length)]};width:${4+Math.random()*9}px;height:${4+Math.random()*9}px;border-radius:${Math.random()>.5?'50%':'2px'}`;
      document.body.appendChild(el);setTimeout(()=>el.remove(),1600);
    },Math.random()*800);
  }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
openDB().then(()=>{
  updateFabVisibility();
  renderDash();
});

// ‚îÄ‚îÄ‚îÄ SERVICE WORKER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js')
      .then(()=>console.log('SavingsBox SW ready'))
      .catch(e=>console.warn('SW:',e));
  });
}

// ‚îÄ‚îÄ‚îÄ INSTALL PROMPT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();deferredPrompt=e;
  setTimeout(()=>{
    if(!deferredPrompt) return;
    const t=document.createElement('div');
    t.className='toast';t.style.cssText='cursor:pointer;pointer-events:auto';
    t.textContent='üì≤ Tap to Add to Home Screen';
    t.onclick=()=>{deferredPrompt.prompt();deferredPrompt.userChoice.then(()=>{deferredPrompt=null;t.remove();});};
    document.getElementById('toasts').appendChild(t);
    setTimeout(()=>t.remove(),8000);
  },3000);
});
window.addEventListener('appinstalled',()=>{showToast('üéâ App installed!');deferredPrompt=null;});
</script>
</body>
</html>
